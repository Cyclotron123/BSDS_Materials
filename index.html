<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BSDS_Materials — Repo Browser</title>
  <style>
    :root{
      --bg-light:#f6f8fa;
      --panel-light:#fff;
      --muted-light:#6b7280;
      --border-light:#e6edf3;

      --bg-dark:#0b0b0d;
      --panel-dark:#0f1113;
      --muted-dark:rgba(255,255,255,0.55);
      --border-dark:rgba(255,255,255,0.04);

      --accent:#58a6ff;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
      --radius:10px;
    }

    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial; -webkit-font-smoothing:antialiased}
    body{
      background:var(--bg-light);
      color:#0f1724;
      padding:28px;
      box-sizing:border-box;
      display:flex;
      justify-content:center;
    }

    .wrap{
      width:100%;
      max-width:1100px;
      background:var(--panel-light);
      border-radius:var(--radius);
      box-shadow:0 8px 30px rgba(2,6,23,0.08);
      overflow:hidden;
      border:1px solid var(--border-light);
    }

    header{
      display:flex;
      gap:12px;
      padding:16px 20px;
      align-items:center;
      border-bottom:1px solid var(--border-light);
      background:linear-gradient(90deg,#fff,#fbfdff);
    }
    header h1{margin:0;font-size:16px}
    header p{margin:0;color:var(--muted-light);font-size:13px}

    main{display:flex;min-height:520px}
    .sidebar{
      width:360px;
      padding:18px;
      border-right:1px solid var(--border-light);
      background:linear-gradient(180deg,#fff,#fbfdff);
      box-sizing:border-box;
    }
    .viewer{
      flex:1;padding:20px;box-sizing:border-box;background:linear-gradient(180deg,#fff,#fbfdff);
    }

    .controls{display:flex;gap:8px;margin-bottom:12px}
    .controls button{
      background:transparent;border:1px solid var(--border-light);padding:8px 10px;border-radius:8px;cursor:pointer;font-size:13px;
    }

    ul.nodes{list-style:none;margin:0;padding:0}
    li.node{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;margin-bottom:6px;cursor:default}
    li.node:hover{background:#f2f6fb}
    .icon{width:20px;text-align:center}
    .name{flex:1;text-align:left;font-size:14px}
    .meta{font-size:12px;color:var(--muted-light)}

    .toggle{width:22px;height:22px;border-radius:6px;display:inline-grid;place-items:center;border:1px solid var(--border-light);background:white;font-weight:700;cursor:pointer}
    .content{background:linear-gradient(180deg,#fff,#fdfeff);padding:14px;border-radius:10px;border:1px solid var(--border-light);min-height:300px;overflow:auto;font-family:var(--mono);font-size:13px;color:#0f1724}
    .note{color:var(--muted-light);font-size:13px;margin-top:10px}

    /* Dark theme rules: white text, dark backgrounds */
    @media (prefers-color-scheme: dark) {
      body{background:var(--bg-dark);color:#fff}
      .wrap{background:var(--panel-dark);border:1px solid var(--border-dark);box-shadow:none}
      header{background:transparent;border-bottom:1px solid var(--border-dark)}
      header p{color:var(--muted-dark)}
      .sidebar{background:transparent;border-right:1px solid var(--border-dark);padding:20px}
      .viewer{background:transparent;padding:20px}
      .controls button{border:1px solid var(--border-dark);color:#fff;background:transparent}
      li.node{color:#fff}
      li.node:hover{background:rgba(255,255,255,0.02)}
      .toggle{background:transparent;border:1px solid var(--border-dark);color:#fff}
      .meta{color:var(--muted-dark)}
      .content{background:#071018;border:1px solid var(--border-dark);color:#fff}
      .note{color:var(--muted-dark)}
    }

    /* Responsive */
    @media (max-width:880px){
      main{flex-direction:column}
      .sidebar{width:100%;border-right:none;border-bottom:1px solid var(--border-light)}
    }
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <svg width="30" height="30" viewBox="0 0 24 24" fill="none" aria-hidden>
        <rect x="3" y="3" width="18" height="18" rx="4" fill="#0ea5e9"></rect>
        <path d="M7 8h10M7 12h10M7 16h6" stroke="#042c3f" stroke-width="1.2" stroke-linecap="round"/>
      </svg>
      <div>
        <h1>BSDS_Materials</h1>
        <p>Toggle folders to explore subfolders and files</p>
      </div>
    </header>

    <main>
      <aside class="sidebar">
        <div class="controls">
          <button id="expandAll">Expand all (first level)</button>
          <button id="collapseAll">Collapse all</button>
          <button id="toggleDotfiles">Toggle dotfiles</button>
        </div>

        <div id="listing">
          <div class="note">Loading repository listing…</div>
        </div>
      </aside>

      <section class="viewer">
        <div id="breadcrumbs" class="note">/</div>
        <h2 id="viewerTitle">Select a file or folder</h2>
        <div class="content" id="viewerContent">
          <div class="note">Click a file to preview text files or open them on GitHub.</div>
        </div>
        <div class="note" style="margin-top:12px">First page shows only parent folders and hides index/readme files there.</div>
      </section>
    </main>
  </div>

  <script>
    const OWNER = 'Cyclotron123';
    const REPO = 'BSDS_Materials';
    const API_ROOT = `https://api.github.com/repos/${OWNER}/${REPO}/contents`;

    const listingEl = document.getElementById('listing');
    const viewerContent = document.getElementById('viewerContent');
    const viewerTitle = document.getElementById('viewerTitle');
    const breadcrumbs = document.getElementById('breadcrumbs');
    const expandAllBtn = document.getElementById('expandAll');
    const collapseAllBtn = document.getElementById('collapseAll');
    const toggleDotfilesBtn = document.getElementById('toggleDotfiles');

    let showDotfiles = false;
    let expanded = new Set();

    async function fetchContents(path = '') {
      const url = path ? `${API_ROOT}/${encodeURIComponent(path)}` : API_ROOT;
      const res = await fetch(url);
      if (!res.ok) throw new Error('GitHub API error ' + res.status);
      return res.json();
    }

    function createNodeElement(item) {
      const li = document.createElement('li');
      li.className = 'node';

      const icon = document.createElement('span');
      icon.className = 'icon';
      icon.textContent = item.type === 'dir' ? '📁' : '📄';

      const name = document.createElement('span');
      name.className = 'name';
      name.textContent = item.name;

      const meta = document.createElement('span');
      meta.className = 'meta';
      meta.textContent = item.type === 'dir' ? 'dir' : `${item.size} bytes`;

      li.appendChild(icon);
      li.appendChild(name);
      li.appendChild(meta);

      if (item.type === 'dir') {
        const t = document.createElement('span');
        t.className = 'toggle';
        t.textContent = expanded.has(item.path) ? '−' : '+';
        t.style.marginRight = '8px';
        li.insertBefore(t, icon);

        const childWrap = document.createElement('div');
        childWrap.style.marginLeft = '28px';
        childWrap.style.display = expanded.has(item.path) ? 'block' : 'none';
        childWrap.dataset.path = item.path;

        t.addEventListener('click', async (e) => {
          e.stopPropagation();
          if (expanded.has(item.path)) {
            expanded.delete(item.path);
            t.textContent = '+';
            childWrap.style.display = 'none';
          } else {
            expanded.add(item.path);
            t.textContent = '−';
            childWrap.style.display = 'block';
            if (!childWrap.dataset.loaded) {
              childWrap.innerHTML = '<div class="note">Loading…</div>';
              try {
                const children = await fetchContents(item.path);
                childWrap.innerHTML = '';
                childWrap.appendChild(renderNodes(children, item.path));
                childWrap.dataset.loaded = '1';
              } catch (err) {
                childWrap.innerHTML = `<div class="note">Unable to load: ${err.message}</div>`;
              }
            }
          }
        });

        li.appendChild(childWrap);
      } else {
        const link = document.createElement('a');
        link.className = 'filelink';
        link.href = item.html_url;
        link.target = '_blank';
        link.rel = 'noopener';
        link.style.textDecoration = 'none';
        link.style.color = 'inherit';
        // clicking preview in viewer rather than open new tab
        li.style.cursor = 'pointer';
        li.addEventListener('click', (e) => {
          e.preventDefault();
          previewFile(item);
        });
      }

      return li;
    }

    function renderNodes(items = [], parentPath = '') {
      items.sort((a,b)=> {
        if (a.type !== b.type) return a.type === 'dir' ? -1 : 1;
        return a.name.localeCompare(b.name, undefined, {sensitivity:'base'});
      });

      const ul = document.createElement('ul');
      ul.className = 'nodes';

      items.forEach(it => {
        if (!showDotfiles && it.name.startsWith('.')) return;
        const li = createNodeElement(it);
        ul.appendChild(li);
      });

      return ul;
    }

    async function buildRootListing() {
      listingEl.innerHTML = '<div class="note">Loading repository listing…</div>';
      try {
        const items = await fetchContents('');
        // First page behavior: show only parent folders and hide index/readme files on the first page
        const rootFolders = items.filter(it => it.type === 'dir');
        listingEl.innerHTML = '';
        listingEl.appendChild(renderNodes(rootFolders, ''));

        const note = document.createElement('div');
        note.className = 'note';
        note.textContent = 'First page: only parent folders are shown; index.html and README files are hidden here.';
        listingEl.appendChild(note);
      } catch (err) {
        listingEl.innerHTML = `<div class="note">Error: ${err.message}</div>`;
      }
    }

    async function previewFile(item) {
      viewerTitle.textContent = item.name;
      breadcrumbs.textContent = item.path || item.name;
      viewerContent.innerHTML = '<div class="note">Loading preview…</div>';

      try {
        const raw = item.download_url || (item.html_url && item.html_url.replace('https://github.com/', 'https://raw.githubusercontent.com/').replace('/blob/','/'));
        if (!raw) { viewerContent.innerHTML = '<div class="note">Preview unavailable</div>'; return; }
        const resp = await fetch(raw);
        if (!resp.ok) {
          viewerContent.innerHTML = '<div class="note">Preview not available, opening on GitHub instead.</div>';
          window.open(item.html_url, '_blank');
          return;
        }
        const ct = resp.headers.get('content-type') || '';
        if (ct.startsWith('text') || ct.includes('json') || ct.includes('markdown') || ct.includes('javascript')) {
          const txt = await resp.text();
          viewerContent.innerHTML = `<pre style="white-space:pre-wrap;word-break:break-word;margin:0">${escapeHtml(txt)}</pre>`;
        } else {
          viewerContent.innerHTML = '<div class="note">Binary or non-text file; opening on GitHub.</div>';
          window.open(item.html_url, '_blank');
        }
      } catch (err) {
        viewerContent.innerHTML = `<div class="note">Could not fetch preview: ${err.message}</div>`;
      }
    }

    function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

    expandAllBtn.addEventListener('click', async () => {
      try {
        const items = await fetchContents('');
        items.forEach(it => { if (it.type === 'dir') expanded.add(it.path); });
        buildRootListing();
      } catch(e){ console.warn(e); }
    });
    collapseAllBtn.addEventListener('click', () => { expanded.clear(); buildRootListing(); });
    toggleDotfilesBtn.addEventListener('click', () => { showDotfiles = !showDotfiles; buildRootListing(); });

    // Initialize
    buildRootListing();

    // Rebuild on color-scheme change so the UI can react if desired
    if (window.matchMedia) {
      const mq = window.matchMedia('(prefers-color-scheme: dark)');
      mq.addEventListener && mq.addEventListener('change', () => buildRootListing());
    }
  </script>
</body>
</html>
